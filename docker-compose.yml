version: '3.8'

services:
  # ===== DMF GATEWAY =====
  gateway:
    image: node:20-alpine
    container_name: dmf-gateway
    working_dir: /app
    volumes:
      - ./gateway:/app
      - /app/node_modules
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: development
      PORT: 5000
      LOVABLE_BACKEND_URL: http://lovable:4000
      DOTNET_BRAIN_URL: http://brain:5183
      DMF_API_KEY: ${DMF_API_KEY:-your-secret-key-CHANGE-ME}
    command: npm start
    depends_on:
      - lovable
      - brain
    networks:
      - dmf-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===== LOVABLE BACKEND (Node.js/Express) =====
  lovable:
    image: node:20-alpine
    container_name: dmf-lovable
    working_dir: /app
    volumes:
      - ./lovable-backend:/app
      - /app/node_modules
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: development
      PORT: 4000
      MONGO_URL: ${MONGO_URL}
      DMF_DB_NAME: ${DMF_DB_NAME:-dmf_music_platform}
      DMF_DB_USER: ${DMF_DB_USER}
    command: npm run dev
    networks:
      - dmf-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===== DOTNET BRAIN (StreamGod) =====
  brain:
    image: mcr.microsoft.com/dotnet/aspnet:8.0
    container_name: dmf-brain
    working_dir: /app
    volumes:
      - ./dmf-music-platform.Web:/app
    ports:
      - "5183:5183"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5183
      DMF__DbName: ${DMF_DB_NAME:-dmf_music_platform}
      DMF__MongoConnection: ${MONGO_URL}
    command: dotnet run --urls http://+:5183
    networks:
      - dmf-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5183/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  dmf-network:
    driver: bridge

# Usage:
# 1. Create .env file with:
#    MONGO_URL=mongodb+srv://bighomiecash8346:PASSWORD@dmf-music-platform.pfqrhc.mongodb.net/dmf_music_platform?retryWrites=true&w=majority
#    DMF_DB_NAME=dmf_music_platform
#    DMF_DB_USER=bighomiecash8346
#    DMF_API_KEY=your-secret-key
#
# 2. Run: docker-compose up -d
#
# 3. Verify:
#    curl http://localhost:5000/health
#    curl http://localhost:4000/health
#    curl http://localhost:5183/health
