rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // Helper functions
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isFounder() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isFounder == true;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
             role in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    function isBotOwner(botId) {
      return isAuthenticated() && 
             resource.data.botId == botId;
    }
    
    // ========================================================================
    // PLAYGROUND BOTS - Bot profiles
    // ========================================================================
    
    match /playground_bots/{botId} {
      // List: System ops or founder can read all
      allow read: if hasRole('system_ops') || isFounder();
      
      // Create: System ops only
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: System ops can update, founder can override
      allow update: if (hasRole('system_ops') || isFounder()) &&
                       // Restrict field updates
                       (request.resource.data.keys().hasAll(['id', 'cohort', 'skillLevel']) ||
                        request.resource.data.active != true); // Only system can change active status
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND LESSONS - Learning tasks
    // ========================================================================
    
    match /playground_lessons/{lessonId} {
      // List: System ops, founder, or bot system
      allow read: if hasRole('system_ops') || isFounder();
      
      // Create: System ops only
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: System ops can update
      allow update: if hasRole('system_ops') || isFounder();
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND ATTEMPTS - Bot work submissions
    // ========================================================================
    
    match /playground_attempts/{attemptId} {
      // List: System ops, founder only
      allow read: if hasRole('system_ops') || isFounder();
      
      // Create: System ops only (bot submissions proxied through API)
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: Only update status during evaluation
      allow update: if (hasRole('system_ops') || isFounder()) &&
                       (request.resource.data.status in ['pending_evaluation', 'evaluated', 'failed_validation']);
      
      // Delete: Founder only (for data correction)
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND EVALUATIONS - Scoring results
    // ========================================================================
    
    match /playground_evaluations/{evaluationId} {
      // List: System ops, founder, analytics
      allow read: if hasRole('system_ops') || hasRole('analytics_reporting') || isFounder();
      
      // Create: Evaluator service only (system ops)
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: System ops only (corrections)
      allow update: if (hasRole('system_ops') || isFounder()) &&
                       // Can't change final scores after evaluation complete
                       request.resource.data.compositeScore == resource.data.compositeScore;
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND PROMOTIONS - Promotion records
    // ========================================================================
    
    match /playground_promotions/{promotionId} {
      // List: System ops, founder, analytics
      allow read: if hasRole('system_ops') || hasRole('analytics_reporting') || isFounder();
      
      // Create: System ops (automatic) or founder (manual override)
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: Founder can override
      allow update: if isFounder() &&
                       (request.resource.data.manualOverride == true ||
                        request.resource.data.approvedBy != null);
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND SKILLS - Skill definitions and graphs
    // ========================================================================
    
    match /playground_skills/{skillId} {
      // List: All authenticated users can read
      allow read: if isAuthenticated();
      
      // Create: System ops only
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: System ops only
      allow update: if hasRole('system_ops') || isFounder();
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND DATASETS - Training data (sanitized)
    // ========================================================================
    
    match /playground_datasets/{datasetId} {
      // List: System ops, founder, metadata_qc cohort
      allow read: if hasRole('system_ops') || hasRole('metadata_qc') || isFounder();
      
      // Create: System ops only
      allow create: if hasRole('system_ops') || isFounder();
      
      // Update: System ops only (mark as sanitized, update stats)
      allow update: if (hasRole('system_ops') || isFounder()) &&
                       // Ensure sanitization status can't be false ? true without re-validation
                       (request.resource.data.sanitized == false || 
                        resource.data.sanitized == true);
      
      // Delete: Founder only (after retention period)
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // PLAYGROUND POLICY EXCEPTIONS - Guardrail overrides
    // ========================================================================
    
    match /playground_policy_exceptions/{exceptionId} {
      // List: Founder and system ops only
      allow read: if hasRole('system_ops') || isFounder();
      
      // Create: Founder only (with approval)
      allow create: if isFounder() &&
                       request.resource.data.approvedBy == request.auth.uid;
      
      // Update: Founder can extend or revoke
      allow update: if isFounder() &&
                       (request.resource.data.expiresAt > now ||
                        request.resource.data.active == false);
      
      // Delete: Founder only
      allow delete: if isFounder();
    }
    
    // ========================================================================
    // DEFAULT DENY - All other paths
    // ========================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ========================================================================
// SECURITY NOTES
// ========================================================================
//
// 1. LEAST PRIVILEGE
//    - Only system_ops and founder roles can modify playground data
//    - Read access strictly limited by role
//    - No public access to evaluation data
//
// 2. DATA INTEGRITY
//    - Bot profiles can only be updated by system
//    - Evaluations are immutable after completion
//    - Promotions create permanent audit trail
//
// 3. GUARDRAILS
//    - Policy exceptions require founder approval
//    - Sanitization status protected
//    - Active status locked to system_ops
//
// 4. AUDIT
//    - All creates/updates logged by Firestore
//    - Promotion records immutable
//    - Dataset sanitization tracked
//
// 5. COMPLIANCE
//    - No production PII in datasets
//    - 90-day retention for experiments
//    - All data encrypted at rest and in transit
//
